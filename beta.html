<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>mediapilot</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #000; color: #fff; }
    h1 { text-align: center; }
    .container { max-width: 700px; margin: auto; background: #111; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(255,255,255,0.06); }
    input, button, select { width: 100%; padding: 10px; margin: 8px 0; border-radius: 5px; border: 1px solid #444; font-size: 16px; background: #222; color: #fff; }
    button { cursor: pointer; background: #007bff; border: none; }
    button:hover { background: #0056b3; }
    ul { padding-left: 0; list-style: none; }
    li { background: #222; padding: 10px; border-radius: 5px; margin-bottom: 6px; display: flex; justify-content: space-between; align-items: center; cursor: grab; }
    li.dragging { opacity: 0.3; }
    .remove { background: #ff4d4d; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
    #convertStatus { font-size: 14px; color: #ddd; }
    .small { font-size: 13px; color:#aaa; }
  </style>
  <!-- ffmpeg.wasm (core will be fetched from CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js""></script>
</head>
<body>
  <div class="container">
    <h1>mediapilot</h1>

    <input id="listName" placeholder="name your list (christmas movies)" />
    <input id="itemInput" placeholder="add anything (sarah by tyler the creator)" />
    <button onclick="addItem()">submit</button>

    <ul id="list"></ul>

    <button onclick="exportList()">export json</button>

    <input type="file" id="fileInput" accept="application/json" style="display:none;" onchange="importList()" />
    <button onclick="document.getElementById('fileInput').click()">import json</button>

    <hr style="margin:20px 0; border-color:#333;" />

    <h2>Convert Images</h2>
    <input type="file" id="mediaConvertInput" accept="image/*" />

    <label>Convert to format:</label>
    <select id="formatSelect">
      <option value="jpg">JPG</option>
      <option value="png">PNG</option>
      <option value="webp">WEBP</option>
    </select>

    <button onclick="convertMedia()">convert image</button>
    <p id="convertStatus"></p>
    <p class="small">Image conversion only. Video conversion removed.</p>Note: image conversions use the browser (fast). Video conversions use ffmpeg.wasm and can be large/slow and may not support all codecs in the browser build.</p>
  </div>

  <script>
    // --- list functionality (unchanged) ---
    let mediaList = [];

    function renderList() {
      const ul = document.getElementById('list');
      ul.innerHTML = '';
      mediaList.forEach((item, index) => {
        const li = document.createElement('li');
        // use a span so we can reliably read textContent even with the remove button
        const span = document.createElement('span');
        span.textContent = item;
        li.appendChild(span);

        li.draggable = true;
        li.dataset.index = index;

        li.addEventListener('dragstart', () => li.classList.add('dragging'));
        li.addEventListener('dragend', () => {
          li.classList.remove('dragging');
          // update mediaList order from DOM
          const newOrder = [...document.querySelectorAll('#list li')].map(li => li.querySelector('span').textContent);
          mediaList = newOrder;
        });

        const btn = document.createElement('button');
        btn.textContent = 'X';
        btn.className = 'remove';
        btn.onclick = () => removeItem(index);

        li.appendChild(btn);
        ul.appendChild(li);
      });
    }

    function addItem() {
      const input = document.getElementById('itemInput');
      if (input.value.trim() !== '') {
        mediaList.push(input.value.trim());
        input.value = '';
        renderList();
      }
    }

    function removeItem(index) {
      mediaList.splice(index, 1);
      renderList();
    }

    function exportList() {
      const data = { name: document.getElementById('listName').value, items: mediaList };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'media-list.json'; a.click(); URL.revokeObjectURL(url);
    }

    function importList() {
      const file = document.getElementById('fileInput').files[0]; if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        try { const data = JSON.parse(e.target.result); document.getElementById('listName').value = data.name||''; mediaList = data.items||[]; renderList(); }
        catch { alert('Invalid JSON file'); }
      };
      reader.readAsText(file);
    }

    // drag reorder
    const ul = document.getElementById('list');
    ul.addEventListener('dragover', e => {
      e.preventDefault();
      const dragging = document.querySelector('.dragging');
      const after = getDragAfter(ul, e.clientY);
      if (!dragging) return;
      if (after == null) ul.appendChild(dragging); else ul.insertBefore(dragging, after);
    });

    function getDragAfter(container, y) {
      const items = [...container.querySelectorAll('li:not(.dragging)')];
      return items.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height/2;
        if (offset < 0 && offset > closest.offset) return { offset, element: child };
        return closest;
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    // --- image-only conversion ---
    async function convertMedia() {
      const fileInput = document.getElementById('mediaConvertInput');
      const file = fileInput.files[0];
      const format = document.getElementById('formatSelect').value;
      const status = document.getElementById('convertStatus');

      if (!file) { status.textContent = 'Select an image first.'; return; }
      status.textContent = 'Converting image...';

      try {
        const dataUrl = await fileToDataURL(file);
        const img = await loadImage(dataUrl);
        const canvas = document.createElement('canvas');
        canvas.width = img.naturalWidth;
        canvas.height = img.naturalHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0);

        const mime = format === 'jpg' ? 'image/jpeg' : (format === 'png' ? 'image/png' : 'image/webp');
        canvas.toBlob(blob => {
          const outName = file.name.replace(/\.[^.]+$/, '') + '.' + format;
          downloadBlob(blob, outName);
          status.textContent = 'Done â€” image downloaded.';
        }, mime, 0.92);
      } catch (err) {
        console.error(err);
        status.textContent = 'Image conversion failed.';
      }
    } / target format combination.';
    }

    // helpers
    function fileToDataURL(file) {
      return new Promise((res, rej) => {
        const r = new FileReader();
        r.onload = () => res(r.result);
        r.onerror = rej;
        r.readAsDataURL(file);
      });
    }

    function loadImage(dataUrl) {
      return new Promise((res, rej) => {
        const img = new Image();
        img.onload = () => res(img);
        img.onerror = rej;
        img.src = dataUrl;
      });
    }

    function downloadBlob(blob, name) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = name; a.click(); URL.revokeObjectURL(url);
    }

    function getFileExtension(name) {
      const m = name.match(/(\.[^.]+)$/);
      return m ? m[0] : '';
    }

  </script>
</body>
</html>
